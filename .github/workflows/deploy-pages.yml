name: deploy-pages
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: pages
  cancel-in-progress: true
jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Inject payment links
        env:
          OVERLORD: ${{ vars.STRIPE_PAYMENT_LINK_OVERLORD }}
          SCHOOL1:  ${{ vars.STRIPE_PAYMENT_LINK_SCHOOL1 }}
          BUNDLE:   ${{ vars.STRIPE_PAYMENT_LINK_BUNDLE }}
          G_OVER:   ${{ vars.GUMROAD_PRODUCT_ID_OVERLORD }}
          G_SCH:    ${{ vars.GUMROAD_PRODUCT_ID_SCHOOL1 }}
          G_BUN:    ${{ vars.GUMROAD_PRODUCT_ID_BUNDLE }}
        run: |
          set -euo pipefail
          sed -i "s|__STRIPE_OVERLORD__|\$OVERLORD|g" site/index.html || true
          sed -i "s|__STRIPE_SCHOOL1__|\$SCHOOL1|g"  site/index.html || true
          sed -i "s|__STRIPE_BUNDLE__|\$BUNDLE|g"   site/index.html || true
          sed -i "s|__GUM_OVERLORD__|\$G_OVER|g"  site/index.html || true
          sed -i "s|__GUM_SCHOOL1__|\$G_SCH|g"    site/index.html || true
          sed -i "s|__GUM_BUNDLE__|\$G_BUN|g"     site/index.html || true
      - uses: actions/configure-pages@v5
        with:
          enablement: true
      - uses: actions/upload-pages-artifact@v4
        with:
          path: ./site
      - id: deployment
        uses: actions/deploy-pages@v4
